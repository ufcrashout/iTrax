{% extends "base.html" %}

{% block title %}Device Management - iTrax{% endblock %}

{% block extra_css %}
    <style>
        .card { border: none; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.08); margin-bottom: 1.5rem; }
        .card-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 15px 15px 0 0 !important; border: none; }
        .device-card { padding: 1.5rem; margin-bottom: 1rem; border-radius: 12px; background: white; border-left: 4px solid #667eea; box-shadow: 0 2px 10px rgba(0,0,0,0.05); transition: transform 0.3s ease, box-shadow 0.3s ease; }
        .device-card:hover { transform: translateY(-2px); box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        .device-has-nickname { border-left-color: #28a745; }
        .device-name { font-size: 1.1rem; font-weight: 600; color: #333; margin-bottom: 0.5rem; }
        .device-nickname { font-size: 1.3rem; font-weight: 700; color: #28a745; margin-bottom: 0.25rem; }
        .device-original-name { font-size: 0.9rem; color: #666; font-style: italic; }
        .device-stats { font-size: 0.875rem; color: #666; margin-top: 0.75rem; }
        .btn-edit { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; border-radius: 8px; color: white; padding: 0.5rem 1rem; font-size: 0.875rem; }
        .btn-edit:hover { background: linear-gradient(135deg, #5a67d8 0%, #6b5b95 100%); transform: translateY(-1px); color: white; }
        .btn-remove { background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); border: none; border-radius: 8px; color: white; padding: 0.5rem 1rem; font-size: 0.875rem; }
        .btn-remove:hover { background: linear-gradient(135deg, #c82333 0%, #a71e2a 100%); transform: translateY(-1px); color: white; }
        .nickname-form { background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-top: 0.75rem; display: none; }
        .form-control:focus { border-color: #667eea; box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25); }
    </style>
{% endblock %}

{% block content %}
        <!-- Page Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h3 class="mb-1">
                                    <i class="fas fa-mobile-alt me-2"></i>Device Management
                                </h3>
                                <p class="mb-0 opacity-75">Manage device nicknames for easier identification</p>
                            </div>
                            <div class="d-grid d-md-block">
                                <button class="btn btn-edit" onclick="refreshDevices()">
                                    <i class="fas fa-sync me-1"></i>Refresh
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Devices List -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-list me-2"></i>All Devices
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="devices-container">
                            {% for device in devices %}
                            <div class="device-card {% if device.nickname %}device-has-nickname{% endif %}" 
                                 data-device="{{ device.device_name }}">
                                <div class="row align-items-center">
                                    <div class="col-md-8">
                                        {% if device.nickname %}
                                        <div class="device-nickname">
                                            <i class="fas fa-tag me-1"></i>{{ device.nickname }}
                                        </div>
                                        <div class="device-original-name">
                                            Device ID: {{ device.device_name }}
                                        </div>
                                        {% else %}
                                        <div class="device-name">
                                            <i class="fas fa-mobile-alt me-1"></i>{{ device.device_name }}
                                        </div>
                                        <div class="text-muted">
                                            <small>No nickname set</small>
                                        </div>
                                        {% endif %}
                                        <div class="device-stats">
                                            <i class="fas fa-map-marker-alt me-1"></i>{{ device.location_count or 0 }} locations
                                            {% if device.last_location %}
                                            â€¢ <i class="fas fa-clock me-1"></i>Last seen: {{ device.last_location | user_timezone }}
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="col-md-4 text-end">
                                        <div class="btn-group" role="group">
                                            <button class="btn btn-edit btn-sm" onclick="editNickname('{{ device.device_name }}', '{{ device.nickname or '' }}')">
                                                <i class="fas fa-edit"></i> {% if device.nickname %}Edit{% else %}Add{% endif %} Nickname
                                            </button>
                                            {% if device.nickname %}
                                            <button class="btn btn-remove btn-sm" onclick="removeNickname('{{ device.device_name }}')">
                                                <i class="fas fa-times"></i> Remove
                                            </button>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Nickname Edit Form -->
                                <div class="nickname-form" id="nickname-form-{{ device.device_name | replace('.', '-') | replace(' ', '-') }}">
                                    <div class="row">
                                        <div class="col-md-8">
                                            <input type="text" class="form-control" 
                                                   placeholder="Enter nickname (e.g., 'Mom's iPhone', 'John's Device')"
                                                   value="{{ device.nickname or '' }}"
                                                   id="nickname-input-{{ device.device_name | replace('.', '-') | replace(' ', '-') }}">
                                        </div>
                                        <div class="col-md-4">
                                            <div class="btn-group w-100" role="group">
                                                <button class="btn btn-success btn-sm" onclick="saveNickname('{{ device.device_name }}')">
                                                    <i class="fas fa-save"></i> Save
                                                </button>
                                                <button class="btn btn-secondary btn-sm" onclick="cancelEdit('{{ device.device_name }}')">
                                                    <i class="fas fa-times"></i> Cancel
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% else %}
                            <div class="text-center py-5">
                                <i class="fas fa-mobile-alt fa-5x text-muted mb-3"></i>
                                <h5 class="text-muted">No Devices Found</h5>
                                <p class="text-muted">Devices will appear here once location data is received.</p>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
{% endblock %}

{% block extra_js %}
    <script>
        // CSRF token from Flask
        const csrf_token = "{{ csrf_token() }}";

        // Convert device name to safe ID
        function deviceToId(deviceName) {
            return deviceName.replace(/\./g, '-').replace(/\s/g, '-');
        }

        // Edit nickname
        function editNickname(deviceName, currentNickname) {
            const formId = `nickname-form-${deviceToId(deviceName)}`;
            const inputId = `nickname-input-${deviceToId(deviceName)}`;
            
            const form = document.getElementById(formId);
            const input = document.getElementById(inputId);
            
            if (form && input) {
                form.style.display = 'block';
                input.value = currentNickname;
                input.focus();
            }
        }

        // Cancel edit
        function cancelEdit(deviceName) {
            const formId = `nickname-form-${deviceToId(deviceName)}`;
            const form = document.getElementById(formId);
            
            if (form) {
                form.style.display = 'none';
            }
        }

        // Save nickname
        async function saveNickname(deviceName) {
            const inputId = `nickname-input-${deviceToId(deviceName)}`;
            const input = document.getElementById(inputId);
            
            if (!input) return;
            
            const nickname = input.value.trim();
            
            if (!nickname) {
                showAlert('Nickname cannot be empty', 'error');
                return;
            }

            try {
                const response = await fetch(`/api/devices/${encodeURIComponent(deviceName)}/nickname`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrf_token
                    },
                    body: JSON.stringify({ nickname: nickname })
                });

                const result = await response.json();
                
                if (result.success) {
                    showAlert(result.message, 'success');
                    setTimeout(() => location.reload(), 1500);
                } else {
                    showAlert(result.error, 'error');
                }
            } catch (error) {
                console.error('Error saving nickname:', error);
                showAlert('Failed to save nickname', 'error');
            }
        }

        // Remove nickname
        async function removeNickname(deviceName) {
            if (!confirm(`Are you sure you want to remove the nickname for "${deviceName}"?`)) return;

            try {
                const response = await fetch(`/api/devices/${encodeURIComponent(deviceName)}/nickname`, {
                    method: 'DELETE',
                    headers: {
                        'X-CSRFToken': csrf_token
                    }
                });

                const result = await response.json();
                
                if (result.success) {
                    showAlert(result.message, 'success');
                    setTimeout(() => location.reload(), 1500);
                } else {
                    showAlert(result.error, 'error');
                }
            } catch (error) {
                console.error('Error removing nickname:', error);
                showAlert('Failed to remove nickname', 'error');
            }
        }

        // Refresh devices
        function refreshDevices() {
            location.reload();
        }

        // Show alert messages
        function showAlert(message, type) {
            const alertClass = type === 'error' ? 'danger' : type;
            const icon = type === 'error' ? 'exclamation-triangle' : 'check-circle';
            
            const alertHtml = `
                <div class="alert alert-${alertClass} alert-dismissible fade show" role="alert">
                    <i class="fas fa-${icon} me-2"></i>
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            
            const container = document.querySelector('.main-content .container');
            container.insertAdjacentHTML('afterbegin', alertHtml);
            
            // Auto-dismiss after 5 seconds
            setTimeout(() => {
                const alert = container.querySelector('.alert');
                if (alert) {
                    const bsAlert = new bootstrap.Alert(alert);
                    bsAlert.close();
                }
            }, 5000);
        }

        // Handle Enter key in nickname inputs
        document.addEventListener('DOMContentLoaded', function() {
            document.addEventListener('keypress', function(e) {
                if (e.target.classList.contains('form-control') && e.key === 'Enter') {
                    const deviceName = e.target.id.replace('nickname-input-', '').replace(/-/g, '.');
                    saveNickname(deviceName);
                }
            });
        });
    </script>
{% endblock %}