<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - iTrax</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body {
            background-color: #f8f9fa;
        }
        .navbar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .navbar-brand {
            font-weight: 600;
            color: white !important;
        }
        .nav-link {
            color: rgba(255,255,255,0.9) !important;
            transition: color 0.3s ease;
        }
        .nav-link:hover {
            color: white !important;
        }
        .main-content {
            padding: 2rem 0;
        }
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            transition: transform 0.3s ease;
        }
        .card:hover {
            transform: translateY(-2px);
        }
        .card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px 15px 0 0 !important;
            border: none;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 10px;
            padding: 0.5rem 1.5rem;
        }
        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        #map {
            height: 500px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .stats-card {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }
        .stats-number {
            font-size: 2rem;
            font-weight: 700;
            color: #667eea;
        }
        .stats-label {
            color: #6c757d;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .device-list {
            max-height: 300px;
            overflow-y: auto;
        }
        .device-item {
            padding: 0.75rem;
            border-bottom: 1px solid #e9ecef;
            transition: background-color 0.3s ease;
        }
        .device-item:hover {
            background-color: #f8f9fa;
        }
        .device-item:last-child {
            border-bottom: none;
        }
        .alert {
            border-radius: 10px;
            border: none;
        }
        .form-control, .form-select {
            border-radius: 10px;
            border: 2px solid #e9ecef;
        }
        .form-control:focus, .form-select:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }
        .loading {
            display: none;
            text-align: center;
            padding: 2rem;
        }
        .spinner-border {
            color: #667eea;
        }
        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .status-active {
            background-color: #28a745;
        }
        .status-inactive {
            background-color: #dc3545;
        }
        .no-data-message {
            margin-top: 10px;
            z-index: 1000;
        }
        
        /* Notification Styles */
        .notification-dropdown {
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            border: none;
            border-radius: 10px;
        }
        .notification-item {
            border-left: 4px solid #007bff;
            margin: 0.5rem;
            padding: 0.75rem;
            border-radius: 0 8px 8px 0;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .notification-item:hover {
            background-color: #f8f9fa;
            transform: translateX(2px);
        }
        .notification-item.unread {
            background-color: #e3f2fd;
            border-left-color: #2196f3;
        }
        .notification-item.read {
            opacity: 0.7;
            border-left-color: #6c757d;
        }
        .notification-item.priority-high {
            border-left-color: #ff9800;
        }
        .notification-item.priority-urgent {
            border-left-color: #f44336;
            animation: pulse-urgent 2s infinite;
        }
        .notification-geofence {
            border-left-color: #4caf50;
        }
        .notification-device {
            border-left-color: #9c27b0;
        }
        .notification-system {
            border-left-color: #607d8b;
        }
        @keyframes pulse-urgent {
            0% { box-shadow: 0 0 0 0 rgba(244, 67, 54, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(244, 67, 54, 0); }
            100% { box-shadow: 0 0 0 0 rgba(244, 67, 54, 0); }
        }
        .notification-badge-animate {
            animation: bounce 0.5s;
        }
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-5px); }
            60% { transform: translateY(-3px); }
        }
        
        /* Mobile Responsive Styles */
        @media (max-width: 991.98px) {
            .navbar-nav {
                padding: 1rem 0;
            }
            .navbar-nav .nav-link {
                padding: 0.75rem 1rem;
                border-bottom: 1px solid rgba(255,255,255,0.1);
            }
            .navbar-nav .nav-link:last-child {
                border-bottom: none;
            }
            .notification-dropdown {
                min-width: 300px !important;
                max-width: 320px !important;
            }
            .navbar-text {
                padding: 0.75rem 1rem;
                border-top: 1px solid rgba(255,255,255,0.1);
                margin: 0 !important;
            }
        }
        
        @media (max-width: 767.98px) {
            #map {
                height: 300px;
            }
            .main-content {
                padding: 1rem 0;
            }
            .stats-card {
                margin-bottom: 0.75rem;
                padding: 1rem;
            }
            .stats-number {
                font-size: 1.75rem;
            }
            .card {
                margin-bottom: 1rem;
            }
            .notification-dropdown {
                min-width: 280px !important;
                max-width: 300px !important;
                margin-right: -1rem;
            }
        }
        
        @media (max-width: 575.98px) {
            .container {
                padding-left: 1rem;
                padding-right: 1rem;
            }
            #map {
                height: 250px;
            }
            .stats-number {
                font-size: 1.5rem;
            }
            .notification-dropdown {
                min-width: 260px !important;
                max-width: 280px !important;
                margin-right: -1.5rem;
            }
            .btn {
                padding: 0.625rem 1.25rem;
                font-size: 0.875rem;
            }
            .card-header h5, .card-header h6 {
                font-size: 1rem;
            }
            /* Touch-friendly form elements */
            .form-control, .form-select, .btn {
                min-height: 44px;
            }
        }
        
        /* Touch optimizations for map */
        .leaflet-container {
            font-size: 14px;
        }
        
        .leaflet-control-zoom a {
            width: 36px;
            height: 36px;
            line-height: 36px;
            font-size: 18px;
        }
        
        .leaflet-touch .leaflet-control-attribution {
            font-size: 11px;
        }
        
        /* Improved notification dropdown for mobile */
        @media (max-width: 991.98px) {
            .notification-dropdown .dropdown-header button {
                font-size: 0.75rem;
                padding: 0.25rem 0.5rem;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="{{ url_for('dashboard') }}">
                <i class="fas fa-map-marker-alt me-2"></i>iTrax
            </a>
            
            <!-- Mobile Hamburger Button -->
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" 
                    aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <!-- Collapsible Navigation -->
            <div class="collapse navbar-collapse" id="navbarNav">
                <div class="navbar-nav ms-auto">
                <a class="nav-link" href="{{ url_for('analytics_dashboard') }}">
                    <i class="fas fa-chart-line me-1"></i>Analytics
                </a>
                <a class="nav-link" href="{{ url_for('heatmap_overview') }}">
                    <i class="fas fa-fire me-1"></i>Heatmap
                </a>
                <a class="nav-link" href="{{ url_for('historical_playback') }}">
                    <i class="fas fa-play me-1"></i>Playback
                </a>
                <a class="nav-link" href="{{ url_for('geofences_overview') }}">
                    <i class="fas fa-shield-alt me-1"></i>Geofences
                </a>
                <a class="nav-link" href="{{ url_for('notifications_overview') }}">
                    <i class="fas fa-bell me-1"></i>Notifications
                </a>
                <a class="nav-link" href="{{ url_for('search_overview') }}">
                    <i class="fas fa-search me-1"></i>Search
                </a>
                <a class="nav-link" href="{{ url_for('travel_reports') }}">
                    <i class="fas fa-file-alt me-1"></i>Reports
                </a>
                {% if route_exists('gps_logs') %}
                <a class="nav-link" href="{{ url_for('gps_logs') }}">
                    <i class="fas fa-list me-1"></i>GPS Logs
                </a>
                {% endif %}
                {% if current_user.is_admin() %}
                <a class="nav-link" href="{{ url_for('user_management') }}">
                    <i class="fas fa-users me-1"></i>Users
                </a>
                {% endif %}
                <!-- Notification Bell -->
                <div class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle position-relative" href="#" id="notificationDropdown" 
                       role="button" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="fas fa-bell"></i>
                        <span id="notificationBadge" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" 
                              style="display: none; font-size: 0.6rem;">0</span>
                    </a>
                    <div class="dropdown-menu dropdown-menu-end notification-dropdown" aria-labelledby="notificationDropdown" 
                         style="min-width: 400px; max-width: 500px;">
                        <div class="dropdown-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0">Notifications</h6>
                            <button class="btn btn-sm btn-outline-primary" onclick="markAllNotificationsRead()">
                                Mark All Read
                            </button>
                        </div>
                        <div class="dropdown-divider"></div>
                        <div id="notificationList" style="max-height: 400px; overflow-y: auto;">
                            <div class="dropdown-item-text text-center text-muted py-4">
                                <i class="fas fa-bell-slash fa-2x mb-2"></i><br>
                                No notifications
                            </div>
                        </div>
                        <div class="dropdown-divider"></div>
                        <div class="dropdown-item-text text-center">
                            <small><a href="#" onclick="loadAllNotifications()" class="text-decoration-none">View All Notifications</a></small>
                        </div>
                    </div>
                </div>
                <span class="navbar-text me-3">
                    <i class="fas fa-user me-1"></i>{{ current_user.id }}
                    {% if current_user.is_admin() %}
                        <span class="badge bg-success ms-1">Admin</span>
                    {% endif %}
                </span>
                <a class="nav-link" href="{{ url_for('logout') }}">
                    <i class="fas fa-sign-out-alt me-1"></i>Logout
                </a>
                </div>
            </div>
        </div>
    </nav>

    <div class="container main-content">
        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
                        <i class="fas fa-{{ 'exclamation-triangle' if category == 'error' else 'info-circle' }} me-2"></i>
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <!-- Stats Cards -->
        <div class="row mb-4">
            <div class="col-sm-6 col-lg-3 mb-3 mb-lg-0">
                <div class="stats-card text-center">
                    <div class="stats-number" id="total-locations">{{ stats.total_locations if stats else 0 }}</div>
                    <div class="stats-label">Total Locations</div>
                </div>
            </div>
            <div class="col-sm-6 col-lg-3 mb-3 mb-lg-0">
                <div class="stats-card text-center">
                    <div class="stats-number" id="unique-devices">{{ stats.unique_devices if stats else 0 }}</div>
                    <div class="stats-label">Devices Tracked</div>
                </div>
            </div>
            <div class="col-sm-6 col-lg-3 mb-3 mb-lg-0">
                <div class="stats-card text-center">
                    <div class="stats-number" id="last-update">
                        {% if stats and stats.last_update %}
                            {{ stats.last_update | user_timezone }}
                        {% else %}
                            N/A
                        {% endif %}
                    </div>
                    <div class="stats-label">Last Update (CST)</div>
                </div>
            </div>
            <div class="col-sm-6 col-lg-3">
                <div class="stats-card text-center">
                    <div class="stats-number" id="today-count">
                        {{ stats.today_count if stats else 0 }}
                    </div>
                    <div class="stats-label">Active Today</div>
                </div>
            </div>
        </div>

        <!-- Movement Tracking Filter -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-route me-2"></i>24-Hour Movement Tracking</h5>
            </div>
            <div class="card-body">
                <form method="get" action="{{ url_for('dashboard') }}" id="movementForm">
                    <div class="row align-items-end">
                        <div class="col-md-4 mb-3 mb-md-0">
                            <label for="date" class="form-label">
                                <i class="fas fa-calendar me-1"></i>Select Date
                            </label>
                            <input type="date" class="form-control" id="date" name="date" 
                                   value="{{ selected_date or '' }}"
                                   max="{{ (moment().format('YYYY-MM-DD')) if moment else '' }}">
                            <div class="form-text">Shows 24-hour movement from 00:00 to 23:59</div>
                        </div>
                        <div class="col-md-4 mb-3 mb-md-0">
                            <label for="device" class="form-label">
                                <i class="fas fa-mobile-alt me-1"></i>Device Filter
                            </label>
                            <select class="form-select" id="device" name="device">
                                <option value="">All Devices</option>
                                {% for device in available_devices %}
                                    <option value="{{ device }}" 
                                            {{ 'selected' if selected_device == device else '' }}>
                                        {{ device }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4">
                            <div class="d-grid d-md-block">
                                <button type="submit" class="btn btn-primary mb-2 mb-md-0 me-md-2">
                                    <i class="fas fa-search me-1"></i>View Movement
                                </button>
                                <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary mb-2 mb-md-0 me-md-1">
                                    <i class="fas fa-home me-1"></i>Today
                                </a>
                                <button type="button" class="btn btn-outline-info" onclick="setYesterday()">
                                    <i class="fas fa-arrow-left me-1"></i>Yesterday
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Movement Summary -->
                    {% if selected_date or selected_device %}
                    <div class="row mt-3">
                        <div class="col-12">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>Viewing:</strong> 
                                {% if selected_date %}
                                    24-hour movement for {{ selected_date }}
                                {% else %}
                                    Last 24 hours of movement
                                {% endif %}
                                {% if selected_device %}
                                    for device "{{ selected_device }}"
                                {% else %}
                                    for all devices
                                {% endif %}
                                <small class="d-block mt-1 text-muted">
                                    <i class="fas fa-lightbulb me-1"></i>
                                    Locations are clustered to avoid too many pins in the same area. 
                                    Only significant movements (~50+ meters) are shown.
                                </small>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </form>
            </div>
        </div>

        <div class="row">
            <!-- Map -->
            <div class="col-lg-8 mb-4 mb-lg-0">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-map me-2"></i>Device Locations</h5>
                    </div>
                    <div class="card-body p-0">
                        <div id="map"></div>
                    </div>
                </div>
            </div>

            <!-- Device List -->
            <div class="col-lg-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-mobile-alt me-2"></i>Tracked Devices</h5>
                    </div>
                    <div class="card-body">
                        <div class="device-list" id="device-list">
                            {% set devices = location_history|map(attribute='device_name')|unique %}
                            {% for device in devices %}
                                <div class="device-item">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <span class="status-indicator status-active"></span>
                                            <i class="fas fa-mobile-alt me-2 text-primary"></i>
                                            <strong>{{ device }}</strong>
                                        </div>
                                        <span class="badge bg-success">Active</span>
                                    </div>
                                    <small class="text-muted">
                                        {% set device_locations = location_history|selectattr('device_name', 'equalto', device)|list %}
                                        {{ device_locations|length }} locations
                                    </small>
                                </div>
                            {% else %}
                                <div class="text-center text-muted py-3">
                                    <i class="fas fa-info-circle fa-2x mb-2"></i>
                                    <p>No devices found</p>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Loading Indicator -->
        <div class="loading" id="loading">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Loading location data...</p>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-dark text-light py-4 mt-5">
        <div class="container text-center">
            <p class="mb-2">&copy; 2025 <strong>iTrax by UF Cra⚡︎hOut</strong>. All rights reserved.</p>
            <p class="mb-0 text-muted">Location tracking and analytics platform</p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Performance optimized map initialization
        var locations = {{ location_history | tojson }};
        var userSettings = {{ user_settings | tojson | safe }} || {
            timezone: 'America/Chicago',
            date_format: '%Y-%m-%d %I:%M:%S %p',
            theme: 'light',
            map_default_zoom: 10,
            refresh_interval: 300
        };
        var markers = [];
        var polylines = [];
        var deviceColors = {};
        var colorPalette = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FECA57', '#FF9FF3', '#54A0FF', '#5F27CD'];
        var colorIndex = 0;
        var map;
        var markersLayer;
        
        // Timezone utility function
        function formatTimestampForUser(timestamp) {
            try {
                const date = new Date(timestamp);
                const options = {
                    timeZone: userSettings.timezone || 'America/Chicago',
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: userSettings.date_format ? userSettings.date_format.includes('%I') : true
                };
                
                return new Intl.DateTimeFormat('en-US', options).format(date);
            } catch (error) {
                console.error('Error formatting timestamp:', error);
                return timestamp;
            }
        }

        // Performance optimization - use LayerGroup for better performance with many markers
        markersLayer = L.layerGroup();

        // Initialize map with performance optimizations
        function initializeMap() {
            if (locations && locations.length > 0) {
                // Calculate center from actual location data efficiently
                var bounds = L.latLngBounds();
                var validLocations = 0;
                
                for (var i = 0; i < locations.length; i++) {
                    var lat = parseFloat(locations[i].latitude);
                    var lng = parseFloat(locations[i].longitude);
                    if (Number.isFinite(lat) && Number.isFinite(lng)) {
                        bounds.extend([lat, lng]);
                        validLocations++;
                    }
                }
                
                if (validLocations > 0) {
                    map = L.map('map', {
                        preferCanvas: true,  // Use Canvas for better performance
                        zoomControl: true,
                        maxZoom: 18
                    }).fitBounds(bounds);
                } else {
                    map = L.map('map', {preferCanvas: true}).setView([39.8283, -98.5795], 4);
                }
            } else {
                // Default to center of US if no location data
                map = L.map('map', {preferCanvas: true}).setView([39.8283, -98.5795], 4);
                
                // Add a message overlay when no data is available
                var noDataDiv = L.control({position: 'topright'});
                noDataDiv.onAdd = function (map) {
                    var div = L.DomUtil.create('div', 'no-data-message');
                    div.innerHTML = '<div style="background: rgba(255,255,255,0.9); padding: 10px; border-radius: 5px; border: 1px solid #ccc; text-align: center;"><i class="fas fa-info-circle text-info"></i> No location data available. Map shows default view.</div>';
                    return div;
                };
                noDataDiv.addTo(map);
            }
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors',
                maxZoom: 18,
                tileSize: 256,
                updateWhenZooming: false,  // Performance optimization
                updateWhenIdle: true
            }).addTo(map);

            // Add markers layer to map
            markersLayer.addTo(map);
        }

        // Group locations by device efficiently
        var deviceLocations = {};
        if (locations && locations.length > 0) {
            for (var i = 0; i < locations.length; i++) {
                var loc = locations[i];
                if (!deviceLocations[loc.device_name]) {
                    deviceLocations[loc.device_name] = [];
                    deviceColors[loc.device_name] = colorPalette[colorIndex % colorPalette.length];
                    colorIndex++;
                }
                deviceLocations[loc.device_name].push(loc);
            }
        }

        // Performance optimized marker and path rendering
        function renderDeviceData() {
            Object.keys(deviceLocations).forEach(function(deviceName) {
                var deviceLocs = deviceLocations[deviceName].sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                var deviceColor = deviceColors[deviceName];
                
                // Create path if more than one location
                if (deviceLocs.length > 1) {
                    var pathCoords = [];
                    // Batch coordinate processing
                    for (var i = 0; i < deviceLocs.length; i++) {
                        var lat = parseFloat(deviceLocs[i].latitude);
                        var lng = parseFloat(deviceLocs[i].longitude);
                        if (Number.isFinite(lat) && Number.isFinite(lng)) {
                            pathCoords.push([lat, lng]);
                        }
                    }
                    
                    if (pathCoords.length > 1) {
                        var polyline = L.polyline(pathCoords, {
                            color: deviceColor,
                            weight: 3,
                            opacity: 0.7,
                            dashArray: '5, 5'
                        });
                        polyline.addTo(map);
                        polylines.push(polyline);
                        
                        polyline.bindPopup(`
                            <div class="text-center">
                                <h6><i class="fas fa-route me-1"></i>Movement Path</h6>
                                <p class="mb-1"><strong>${deviceName}</strong></p>
                                <p class="mb-0"><small>${deviceLocs.length} locations tracked</small></p>
                            </div>
                        `);
                    }
                }
                
                // Batch marker creation - only show most important markers for performance
                var markersToShow = [];
                if (deviceLocs.length > 0) {
                    markersToShow.push({loc: deviceLocs[0], type: 'start', index: 0}); // First
                    if (deviceLocs.length > 1) {
                        markersToShow.push({loc: deviceLocs[deviceLocs.length - 1], type: 'end', index: deviceLocs.length - 1}); // Last
                    }
                    
                    // Add middle markers only if we have few locations or user zooms in
                    if (deviceLocs.length <= 20) {
                        for (var i = 1; i < deviceLocs.length - 1; i++) {
                            markersToShow.push({loc: deviceLocs[i], type: 'middle', index: i});
                        }
                    }
                }
                
                // Batch create markers
                markersToShow.forEach(function(markerInfo) {
                    var loc = markerInfo.loc;
                    var index = markerInfo.index;
                var isFirst = index === 0;
                var isLast = index === deviceLocs.length - 1;
                var isMiddle = !isFirst && !isLast;
                
                var markerColor = deviceColor;
                var iconHtml = '';
                var title = '';
                
                if (isFirst) {
                    iconHtml = `<div style="background-color: ${markerColor}; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 5px rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center;"><i class="fas fa-play" style="color: white; font-size: 8px;"></i></div>`;
                    title = 'Start Location';
                } else if (isLast) {
                    iconHtml = `<div style="background-color: ${markerColor}; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 5px rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center;"><i class="fas fa-stop" style="color: white; font-size: 8px;"></i></div>`;
                    title = 'Latest Location';
                } else {
                    iconHtml = `<div style="background-color: ${markerColor}; width: 12px; height: 12px; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 3px rgba(0,0,0,0.3); opacity: 0.8;"></div>`;
                    title = 'Movement Point';
                }
                
                var customIcon = L.divIcon({
                    className: 'custom-marker',
                    html: iconHtml,
                    iconSize: [20, 20],
                    iconAnchor: [10, 10]
                });
                
                    var latNum = parseFloat(loc.latitude);
                    var lngNum = parseFloat(loc.longitude);
                    if (!Number.isFinite(latNum) || !Number.isFinite(lngNum)) return;
                    
                    var marker = L.marker([latNum, lngNum], { icon: customIcon })
                        .bindPopup(`
                            <div class="text-center">
                                <h6><i class="fas fa-mobile-alt me-1"></i>${loc.device_name}</h6>
                                <p class="mb-1" style="color: ${markerColor}"><strong>${title}</strong></p>
                                <p class="mb-1">${Number(latNum).toFixed(6)}, ${Number(lngNum).toFixed(6)}</p>
                                <p class="mb-0"><small>${formatTimestampForUser(loc.timestamp)}</small></p>
                                ${index > 0 ? `<hr class="my-2"><small class="text-muted">Point ${index + 1} of ${deviceLocs.length}</small>` : ''}
                            </div>
                        `);
                    
                    // Add to markers layer for better performance
                    markersLayer.addLayer(marker);
                    markers.push(marker);
                });
            });
        }

        // Lazy loading initialization when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize map first
            initializeMap();
            
            // Then render data with a slight delay for better UX
            setTimeout(function() {
                renderDeviceData();
                
                // Fit map to show all markers if any exist
                if (markers.length > 0) {
                    var group = new L.featureGroup(markers);
                    map.fitBounds(group.getBounds().pad(0.1));
                }
            }, 100); // 100ms delay for better UX
        });

        // Helper functions for date controls
        function setYesterday() {
            var yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            document.getElementById('date').value = yesterday.toISOString().split('T')[0];
        }

        // Set max date to today
        (function(){
            var dateEl = document.getElementById('date');
            if (dateEl) {
                dateEl.max = new Date().toISOString().split('T')[0];
            }
        })();

        // Update statistics
        function updateStats() {
            fetch('/api/stats')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('total-locations').textContent = data.total_locations;
                    document.getElementById('unique-devices').textContent = data.unique_devices;
                    document.getElementById('today-count').textContent = data.today_count;
                    if (data.last_update) {
                        document.getElementById('last-update').textContent = data.last_update.substring(0, 10);
                    }
                })
                .catch(error => console.error('Error updating stats:', error));
        }

        // Auto-refresh functionality
        function refreshData() {
            var selectedDate = "{{ selected_date or '' }}";
            var selectedDevice = "{{ selected_device or '' }}";

            // Build query for last 24h or selected date window
            var params = new URLSearchParams();
            if (selectedDevice) params.set('device', selectedDevice);
            if (selectedDate) {
                // 00:00:00 to 23:59:59 of selected date
                var start = new Date(selectedDate + 'T00:00:00');
                var end = new Date(selectedDate + 'T23:59:59');
                params.set('start', start.toISOString());
                params.set('end', end.toISOString());
                params.set('limit', '20000');
            } else {
                // last 24 hours
                var endNow = new Date();
                var start24h = new Date(endNow.getTime() - 24*60*60*1000);
                params.set('start', start24h.toISOString());
                params.set('end', endNow.toISOString());
                params.set('limit', '20000');
            }

            fetch('/api/locations?' + params.toString())
                .then(response => response.json())
                .then(data => {
                    // Clear existing markers and polylines
                    markers.forEach(marker => markersLayer.removeLayer(marker));
                    markers = [];
                    polylines.forEach(line => map.removeLayer(line));
                    polylines = [];

                    // Update global locations data with new data
                    locations = data;
                    
                    // Rebuild device grouping
                    deviceLocations = {};
                    deviceColors = {};
                    colorIndex = 0;
                    
                    if (locations && locations.length > 0) {
                        for (var i = 0; i < locations.length; i++) {
                            var loc = locations[i];
                            if (!deviceLocations[loc.device_name]) {
                                deviceLocations[loc.device_name] = [];
                                deviceColors[loc.device_name] = colorPalette[colorIndex % colorPalette.length];
                                colorIndex++;
                            }
                            deviceLocations[loc.device_name].push(loc);
                        }
                    }

                    // Re-render all device data using existing function
                    renderDeviceData();

                    if (markers.length > 0) {
                        var group = new L.featureGroup(markers);
                        map.fitBounds(group.getBounds().pad(0.1));
                    } else {
                        map.setView([39.8283, -98.5795], 4);
                    }

                    // Update statistics
                    updateStats();
                })
                .catch(error => console.error('Error refreshing data:', error));
        }

        // Auto-refresh every 5 minutes
        setInterval(refreshData, 300000);

        // Update stats every minute
        setInterval(updateStats, 60000);

        // Form validation (guarded)
        (function() {
            var movementForm = document.getElementById('movementForm');
            if (!movementForm) return;
            movementForm.addEventListener('submit', function(e) {
                var startEl = document.getElementById('start');
                var endEl = document.getElementById('end');
                if (!startEl || !endEl) return;
                var start = startEl.value;
                var end = endEl.value;
                if (start && end && new Date(start) >= new Date(end)) {
                    e.preventDefault();
                    alert('End time must be after start time.');
                }
            });
        })();
        
        // Notification System JavaScript
        let notificationCount = 0;
        const csrf_token = "{{ csrf_token() }}";

        // Load notification count
        async function loadNotificationCount() {
            try {
                const response = await fetch('/api/notifications/count');
                const result = await response.json();
                
                if (result.success) {
                    updateNotificationBadge(result.unread_count);
                }
            } catch (error) {
                console.error('Error loading notification count:', error);
            }
        }

        // Update notification badge
        function updateNotificationBadge(count) {
            const badge = document.getElementById('notificationBadge');
            if (count > 0) {
                badge.textContent = count;
                badge.style.display = 'inline-block';
                if (count > notificationCount) {
                    badge.classList.add('notification-badge-animate');
                    setTimeout(() => badge.classList.remove('notification-badge-animate'), 500);
                }
            } else {
                badge.style.display = 'none';
            }
            notificationCount = count;
        }

        // Load notifications
        async function loadNotifications(unreadOnly = true) {
            try {
                const response = await fetch(`/api/notifications?unread_only=${unreadOnly}&limit=10`);
                const result = await response.json();
                
                if (result.success) {
                    displayNotifications(result.notifications);
                }
            } catch (error) {
                console.error('Error loading notifications:', error);
            }
        }

        // Display notifications in dropdown
        function displayNotifications(notifications) {
            const notificationList = document.getElementById('notificationList');
            
            if (notifications.length === 0) {
                notificationList.innerHTML = `
                    <div class="dropdown-item-text text-center text-muted py-4">
                        <i class="fas fa-bell-slash fa-2x mb-2"></i><br>
                        No notifications
                    </div>
                `;
                return;
            }

            let html = '';
            notifications.forEach(notification => {
                const timeAgo = getTimeAgo(new Date(notification.timestamp));
                const isUnread = !notification.is_read;
                const priorityClass = `priority-${notification.priority}`;
                const typeClass = `notification-${notification.notification_type}`;
                
                html += `
                    <div class="notification-item ${isUnread ? 'unread' : 'read'} ${priorityClass} ${typeClass}"
                         onclick="markNotificationRead(${notification.id})"
                         data-notification-id="${notification.id}">
                        <div class="d-flex justify-content-between">
                            <div class="flex-grow-1">
                                <div class="d-flex align-items-center mb-1">
                                    <i class="fas fa-${getNotificationIcon(notification.notification_type, notification.event_type)} me-2"></i>
                                    <strong>${notification.device_name}</strong>
                                    ${isUnread ? '<span class="badge bg-primary ms-2">New</span>' : ''}
                                </div>
                                <p class="mb-1">${notification.message}</p>
                                <small class="text-muted">
                                    <i class="fas fa-clock me-1"></i>${timeAgo}
                                    ${notification.geofence_name ? `• <i class="fas fa-map-marker-alt me-1"></i>${notification.geofence_name}` : ''}
                                </small>
                            </div>
                        </div>
                    </div>
                `;
            });

            notificationList.innerHTML = html;
        }

        // Get notification icon based on type and event
        function getNotificationIcon(type, event) {
            switch(type) {
                case 'geofence':
                    return event === 'entry' ? 'sign-in-alt' : event === 'exit' ? 'sign-out-alt' : 'map-marker-alt';
                case 'device':
                    return 'mobile-alt';
                case 'system':
                    return 'cog';
                default:
                    return 'bell';
            }
        }

        // Calculate time ago
        function getTimeAgo(date) {
            const now = new Date();
            const diff = Math.floor((now - date) / 1000);
            
            if (diff < 60) return 'Just now';
            if (diff < 3600) return `${Math.floor(diff / 60)}m ago`;
            if (diff < 86400) return `${Math.floor(diff / 3600)}h ago`;
            return `${Math.floor(diff / 86400)}d ago`;
        }

        // Mark notification as read
        async function markNotificationRead(notificationId) {
            try {
                const response = await fetch(`/api/notifications/${notificationId}/read`, {
                    method: 'PUT',
                    headers: {
                        'X-CSRFToken': csrf_token
                    }
                });

                if (response.ok) {
                    // Update UI
                    const notificationItem = document.querySelector(`[data-notification-id="${notificationId}"]`);
                    if (notificationItem) {
                        notificationItem.classList.remove('unread');
                        notificationItem.classList.add('read');
                        const newBadge = notificationItem.querySelector('.badge');
                        if (newBadge) newBadge.remove();
                    }
                    
                    // Update count
                    loadNotificationCount();
                }
            } catch (error) {
                console.error('Error marking notification as read:', error);
            }
        }

        // Mark all notifications as read
        async function markAllNotificationsRead() {
            try {
                const response = await fetch('/api/notifications/mark-all-read', {
                    method: 'PUT',
                    headers: {
                        'X-CSRFToken': csrf_token
                    }
                });

                if (response.ok) {
                    // Reload notifications and count
                    loadNotifications();
                    loadNotificationCount();
                }
            } catch (error) {
                console.error('Error marking all notifications as read:', error);
            }
        }

        // Load all notifications (for future full notifications page)
        function loadAllNotifications() {
            // TODO: Navigate to full notifications page
            alert('Full notifications page coming soon!');
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Load initial notification count
            loadNotificationCount();
            
            // Load notifications when dropdown is opened
            document.getElementById('notificationDropdown').addEventListener('click', function() {
                loadNotifications();
            });
            
            // Poll for new notifications every 30 seconds
            setInterval(loadNotificationCount, 30000);
        });
    </script>
</body>
</html>