<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Geofences - iTrax</title>
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { background-color: #f8f9fa; }
        .navbar { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
        }
        .navbar-brand, .nav-link { color: white !important; }
        .nav-link:hover { color: #e3f2fd !important; }
        .main-content { padding: 2rem 0; }
        .card { 
            border: none; border-radius: 15px; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.08); 
            margin-bottom: 1.5rem;
        }
        .card-header { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; border-radius: 15px 15px 0 0 !important; border: none; 
        }
        #map { height: 400px; border-radius: 15px; }
        .geofence-item {
            padding: 1rem; border-left: 4px solid #4CAF50; 
            background: white; margin-bottom: 1rem; border-radius: 0 10px 10px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05); transition: transform 0.3s ease;
        }
        .geofence-item:hover { transform: translateX(5px); }
        .geofence-inactive {
            border-left-color: #ccc; opacity: 0.6;
        }
        .event-item {
            padding: 0.75rem; margin-bottom: 0.5rem; border-radius: 8px;
            background: white; border-left: 4px solid #2196f3;
        }
        .event-enter { border-left-color: #4CAF50; }
        .event-exit { border-left-color: #ff5722; }
        .btn-create { 
            background: linear-gradient(135deg, #4CAF50 0%, #66BB6A 100%);
            border: none; border-radius: 10px; color: white;
        }
        .btn-create:hover { 
            transform: translateY(-1px); box-shadow: 0 5px 15px rgba(76, 175, 80, 0.4);
            color: white;
        }
        .radius-badge { 
            background: #2196f3; color: white; font-size: 0.8rem; 
            padding: 0.25rem 0.75rem; border-radius: 15px; 
        }
        .device-badge { 
            background: #ff9800; color: white; font-size: 0.8rem; 
            padding: 0.25rem 0.75rem; border-radius: 15px; 
        }
        .alert-badge { 
            background: #9c27b0; color: white; font-size: 0.8rem; 
            padding: 0.25rem 0.5rem; border-radius: 10px; margin: 0.25rem;
        }
        .map-creator {
            cursor: crosshair;
        }
        .temp-circle {
            fill: rgba(76, 175, 80, 0.3);
            stroke: #4CAF50;
            stroke-width: 2;
        }
        /* Notification Styles */
        .notification-bell {
            position: relative;
            cursor: pointer;
        }
        .notification-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #dc3545;
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 10px;
            display: none;
            align-items: center;
            justify-content: center;
            animation: none;
        }
        .notification-badge-animate {
            animation: pulse 0.5s ease-in-out;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        .notification-dropdown {
            min-width: 350px;
            max-height: 400px;
            overflow-y: auto;
        }
        .notification-item {
            padding: 12px 16px;
            border-bottom: 1px solid #dee2e6;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .notification-item:last-child {
            border-bottom: none;
        }
        .notification-item:hover {
            background-color: #f8f9fa;
        }
        .notification-item.unread {
            background-color: #e3f2fd;
            border-left: 4px solid #2196f3;
        }
        .notification-item.read {
            opacity: 0.8;
        }
        .notification-item.priority-urgent {
            border-left-color: #dc3545 !important;
        }
        .notification-item.priority-high {
            border-left-color: #fd7e14 !important;
        }
        .notification-item.priority-normal {
            border-left-color: #2196f3 !important;
        }
        .notification-item.priority-low {
            border-left-color: #6c757d !important;
        }
        
        /* Mobile Responsive Styles */
        @media (max-width: 991.98px) {
            .navbar-nav {
                padding: 1rem 0;
            }
            .navbar-nav .nav-link {
                padding: 0.75rem 1rem;
                border-bottom: 1px solid rgba(255,255,255,0.1);
            }
            .navbar-nav .nav-link:last-child {
                border-bottom: none;
            }
            .notification-dropdown {
                min-width: 300px !important;
                max-width: 320px !important;
            }
            .navbar-text {
                padding: 0.75rem 1rem;
                border-top: 1px solid rgba(255,255,255,0.1);
                margin: 0 !important;
            }
        }

        @media (max-width: 767.98px) {
            #map {
                height: 300px;
            }
            .main-content {
                padding: 1rem 0;
            }
            .stats-card {
                margin-bottom: 0.75rem;
                padding: 1rem;
            }
            .stats-number {
                font-size: 1.75rem;
            }
            .card {
                margin-bottom: 1rem;
            }
            .notification-dropdown {
                min-width: 280px !important;
                max-width: 300px !important;
                margin-right: -1rem;
            }
        }

        @media (max-width: 575.98px) {
            .container {
                padding-left: 1rem;
                padding-right: 1rem;
            }
            #map {
                height: 250px;
            }
            .stats-number {
                font-size: 1.5rem;
            }
            .notification-dropdown {
                min-width: 260px !important;
                max-width: 280px !important;
                margin-right: -1.5rem;
            }
            .btn {
                padding: 0.625rem 1.25rem;
                font-size: 0.875rem;
            }
            .card-header h5, .card-header h6 {
                font-size: 1rem;
            }
            /* Touch-friendly form elements */
            .form-control, .form-select, .btn {
                min-height: 44px;
            }
        }

        /* Touch optimizations for map */
        .leaflet-container {
            font-size: 14px;
        }

        .leaflet-control-zoom a {
            width: 36px;
            height: 36px;
            line-height: 36px;
            font-size: 18px;
        }

        .leaflet-touch .leaflet-control-attribution {
            font-size: 11px;
        }

        /* Improved notification dropdown for mobile */
        @media (max-width: 991.98px) {
            .notification-dropdown .dropdown-header button {
                font-size: 0.75rem;
                padding: 0.25rem 0.5rem;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="{{ url_for('dashboard') }}">
                <i class="fas fa-map-marker-alt me-2"></i>iTrax
            </a>
            
            <!-- Mobile Hamburger Button -->
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" 
                    aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <!-- Collapsible Navigation -->
            <div class="collapse navbar-collapse" id="navbarNav">
                <div class="navbar-nav ms-auto">
                <a class="nav-link" href="{{ url_for('dashboard') }}">
                    <i class="fas fa-map me-1"></i>Dashboard
                </a>
                <a class="nav-link" href="{{ url_for('analytics_dashboard') }}">
                    <i class="fas fa-chart-line me-1"></i>Analytics
                </a>
                <a class="nav-link" href="{{ url_for('heatmap_overview') }}">
                    <i class="fas fa-fire me-1"></i>Heatmap
                </a>
                <a class="nav-link" href="{{ url_for('historical_playback') }}">
                    <i class="fas fa-play me-1"></i>Playback
                </a>
                <a class="nav-link active" href="{{ url_for('geofences_overview') }}">
                    <i class="fas fa-shield-alt me-1"></i>Geofences
                </a>
                <a class="nav-link" href="{{ url_for('notifications_overview') }}">
                    <i class="fas fa-bell me-1"></i>Notifications
                </a>
                <a class="nav-link" href="{{ url_for('search_overview') }}">
                    <i class="fas fa-search me-1"></i>Search
                </a>
                <a class="nav-link" href="{{ url_for('travel_reports') }}">
                    <i class="fas fa-file-alt me-1"></i>Reports
                </a>
                {% if route_exists('gps_logs') %}
                <a class="nav-link" href="{{ url_for('gps_logs') }}">
                    <i class="fas fa-list me-1"></i>GPS Logs
                </a>
                {% endif %}
                <!-- Notification Bell -->
                <div class="nav-item dropdown me-3">
                    <a class="nav-link notification-bell" href="#" id="notificationDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="fas fa-bell"></i>
                        <span class="notification-badge" id="notificationBadge">0</span>
                    </a>
                    <div class="dropdown-menu dropdown-menu-end notification-dropdown" aria-labelledby="notificationDropdown">
                        <div class="d-flex justify-content-between align-items-center p-3 border-bottom">
                            <h6 class="mb-0">Notifications</h6>
                            <div>
                                <button class="btn btn-sm btn-outline-primary me-2" onclick="markAllNotificationsRead()">
                                    <i class="fas fa-check-double"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-secondary" onclick="loadAllNotifications()">
                                    <i class="fas fa-list"></i>
                                </button>
                            </div>
                        </div>
                        <div id="notificationList">
                            <div class="dropdown-item-text text-center text-muted py-4">
                                <i class="fas fa-spinner fa-spin fa-2x mb-2"></i><br>
                                Loading notifications...
                            </div>
                        </div>
                    </div>
                </div>
                <span class="navbar-text me-3">
                    <i class="fas fa-user me-1"></i>{{ current_user.id }}
                </span>
                <a class="nav-link" href="{{ url_for('logout') }}">
                    <i class="fas fa-sign-out-alt me-1"></i>Logout
                </a>
                </div>
            </div>
        </div>
    </nav>

    <div class="container main-content">
        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
                        <i class="fas fa-{{ 'exclamation-triangle' if category == 'error' else 'info-circle' }} me-2"></i>
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <!-- Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h3 class="mb-1">
                                    <i class="fas fa-shield-alt me-2"></i>Geofences
                                </h3>
                                <p class="mb-0 opacity-75">Create virtual boundaries and receive alerts for device movements</p>
                            </div>
                            <div class="d-grid d-md-block">
                                <button class="btn btn-create" onclick="startGeofenceCreation()">
                                    <i class="fas fa-plus me-1"></i>Create Geofence
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Map -->
            <div class="col-lg-8 mb-4 mb-lg-0">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-map me-2"></i><span id="mapTitle">Geofence Map</span>
                        </h5>
                    </div>
                    <div class="card-body p-0">
                        <div id="map"></div>
                    </div>
                </div>
            </div>

            <!-- Controls -->
            <div class="col-lg-4">
                <!-- Active Geofences -->
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="fas fa-shield-alt me-2"></i>Active Geofences ({{ geofences|length }})
                        </h6>
                    </div>
                    <div class="card-body">
                        <div id="geofenceList">
                            {% for geofence in geofences %}
                            <div class="geofence-item {{ 'geofence-inactive' if not geofence.is_active else '' }}" 
                                 data-geofence-id="{{ geofence.id }}" onclick="focusGeofence({{ geofence.id }})">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <div class="fw-bold">{{ geofence.name }}</div>
                                    <button class="btn btn-sm btn-outline-danger" onclick="event.stopPropagation(); deleteGeofence({{ geofence.id }})">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                                <div class="mb-2">
                                    <span class="radius-badge me-1">{{ geofence.radius_meters }}m</span>
                                    {% if geofence.device_filter %}
                                        <span class="device-badge">{{ geofence.device_filter }}</span>
                                    {% endif %}
                                </div>
                                <div class="mb-2">
                                    {% for alert_type in geofence.alert_types %}
                                        <span class="alert-badge">{{ alert_type }}</span>
                                    {% endfor %}
                                </div>
                                <small class="text-muted">
                                    Created: {{ geofence.created_at | to_cst_date }}
                                </small>
                            </div>
                            {% else %}
                            <div class="text-center text-muted py-4">
                                <i class="fas fa-shield-alt fa-3x mb-3 opacity-25"></i>
                                <p>No geofences created yet</p>
                                <button class="btn btn-create" onclick="startGeofenceCreation()">
                                    <i class="fas fa-plus me-1"></i>Create First Geofence
                                </button>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <!-- Recent Events -->
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="fas fa-bell me-2"></i>Recent Events
                        </h6>
                    </div>
                    <div class="card-body">
                        <div style="max-height: 300px; overflow-y: auto;">
                            {% for event in recent_events %}
                            <div class="event-item event-{{ event.event_type.lower() }}">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <div class="fw-bold">
                                            <i class="fas fa-{{ 'sign-in-alt' if event.event_type == 'ENTER' else 'sign-out-alt' }} me-1"></i>
                                            {{ event.event_type.title() }}
                                        </div>
                                        <div class="small">{{ event.device_name }} • {{ event.geofence_name }}</div>
                                    </div>
                                    <small class="text-muted">{{ event.timestamp | to_cst }}</small>
                                </div>
                            </div>
                            {% else %}
                            <div class="text-center text-muted py-4">
                                <i class="fas fa-bell fa-2x mb-2 opacity-25"></i>
                                <p>No recent events</p>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Geofence Modal -->
    <div class="modal fade" id="createGeofenceModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-plus me-2"></i>Create Geofence
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="createGeofenceForm">
                        <div class="mb-3">
                            <label for="geofenceName" class="form-label">Geofence Name</label>
                            <input type="text" class="form-control" id="geofenceName" required>
                        </div>
                        <div class="row">
                            <div class="col-sm-6 mb-3 mb-sm-0">
                                <label for="centerLat" class="form-label">Latitude</label>
                                <input type="number" class="form-control" id="centerLat" step="any" readonly>
                            </div>
                            <div class="col-sm-6">
                                <label for="centerLng" class="form-label">Longitude</label>
                                <input type="number" class="form-control" id="centerLng" step="any" readonly>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="radius" class="form-label">Radius (meters)</label>
                            <input type="number" class="form-control" id="radius" min="10" max="10000" value="100" required>
                        </div>
                        <div class="mb-3">
                            <label for="deviceFilter" class="form-label">Device Filter (optional)</label>
                            <select class="form-select" id="deviceFilter">
                                <option value="">All Devices</option>
                                {% for device in available_devices %}
                                    <option value="{{ device }}">{{ device }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Alert Types</label>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="alertEnter" value="enter" checked>
                                <label class="form-check-label" for="alertEnter">Entry Alert</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="alertExit" value="exit" checked>
                                <label class="form-check-label" for="alertExit">Exit Alert</label>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <div class="d-grid d-md-block w-100">
                        <button type="button" class="btn btn-secondary mb-2 mb-md-0 me-md-2" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-create" onclick="createGeofence()">
                            <i class="fas fa-plus me-1"></i>Create
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-dark text-light py-4 mt-5">
        <div class="container text-center">
            <p class="mb-2">&copy; 2025 <strong>iTrax by UF Cra⚡︎hOut</strong>. All rights reserved.</p>
            <p class="mb-0 text-muted">Location tracking and analytics platform</p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Global variables
        let map;
        let geofences = {{ geofences | tojson }};
        let recentLocations = {{ recent_locations | tojson }};
        let geofenceCircles = {};
        let isCreatingGeofence = false;
        let tempCircle = null;
        let createGeofenceModal;

        // Initialize map
        function initializeMap() {
            // Determine initial map center and zoom
            let initialCenter = [39.8283, -98.5795]; // Geographic center of USA
            let initialZoom = 4;
            
            // If we have geofences, use their bounds
            if (geofences.length > 0) {
                // Calculate center from existing geofences
                let totalLat = 0, totalLng = 0;
                geofences.forEach(geofence => {
                    totalLat += parseFloat(geofence.center_lat);
                    totalLng += parseFloat(geofence.center_lng);
                });
                initialCenter = [totalLat / geofences.length, totalLng / geofences.length];
                initialZoom = 13;
            }
            // If no geofences but we have recent device locations, center on those
            else if (recentLocations && recentLocations.length > 0) {
                let totalLat = 0, totalLng = 0;
                recentLocations.forEach(location => {
                    totalLat += parseFloat(location.lat);
                    totalLng += parseFloat(location.lng);
                });
                initialCenter = [totalLat / recentLocations.length, totalLng / recentLocations.length];
                initialZoom = 11;
            }
            
            map = L.map('map').setView(initialCenter, initialZoom);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);

            // Initialize modal
            createGeofenceModal = new bootstrap.Modal(document.getElementById('createGeofenceModal'));

            // Load existing geofences
            loadGeofences();

            // Add click handler for creating geofences
            map.on('click', onMapClick);
        }

        // Load geofences on map
        function loadGeofences() {
            geofences.forEach(geofence => {
                if (geofence.is_active) {
                    addGeofenceToMap(geofence);
                }
            });

            // Fit map to show all geofences
            if (geofences.length > 0 && Object.keys(geofenceCircles).length > 0) {
                const group = new L.featureGroup(Object.values(geofenceCircles));
                map.fitBounds(group.getBounds().pad(0.1));
            }
        }

        // Add geofence circle to map
        function addGeofenceToMap(geofence) {
            const circle = L.circle([geofence.center_lat, geofence.center_lng], {
                color: getGeofenceColor(geofence),
                fillColor: getGeofenceColor(geofence),
                fillOpacity: 0.2,
                radius: geofence.radius_meters,
                weight: 3
            }).addTo(map);

            circle.bindPopup(`
                <div class="text-center">
                    <h6><i class="fas fa-shield-alt me-1"></i>${geofence.name}</h6>
                    <p class="mb-1"><strong>Radius:</strong> ${geofence.radius_meters}m</p>
                    ${geofence.device_filter ? `<p class="mb-1"><strong>Device:</strong> ${geofence.device_filter}</p>` : ''}
                    <p class="mb-0"><strong>Alerts:</strong> ${geofence.alert_types.join(', ')}</p>
                </div>
            `);

            geofenceCircles[geofence.id] = circle;
        }

        // Get color for geofence based on properties
        function getGeofenceColor(geofence) {
            if (geofence.device_filter) {
                return '#ff9800'; // Orange for device-specific
            }
            return '#4CAF50'; // Green for all devices
        }

        // Handle map clicks for geofence creation
        function onMapClick(e) {
            if (isCreatingGeofence) {
                const lat = e.latlng.lat;
                const lng = e.latlng.lng;
                
                // Set coordinates in form
                document.getElementById('centerLat').value = lat;
                document.getElementById('centerLng').value = lng;
                
                // Show preview circle
                showPreviewCircle(lat, lng, 100);
                
                // Show modal
                createGeofenceModal.show();
            }
        }

        // Start geofence creation mode
        function startGeofenceCreation() {
            isCreatingGeofence = true;
            map.getContainer().style.cursor = 'crosshair';
            document.getElementById('mapTitle').textContent = 'Click on map to place geofence';
        }

        // End geofence creation mode
        function endGeofenceCreation() {
            isCreatingGeofence = false;
            map.getContainer().style.cursor = '';
            document.getElementById('mapTitle').textContent = 'Geofence Map';
            
            if (tempCircle) {
                map.removeLayer(tempCircle);
                tempCircle = null;
            }
        }

        // Show preview circle
        function showPreviewCircle(lat, lng, radius) {
            if (tempCircle) {
                map.removeLayer(tempCircle);
            }
            
            tempCircle = L.circle([lat, lng], {
                color: '#4CAF50',
                fillColor: '#4CAF50',
                fillOpacity: 0.3,
                radius: radius,
                weight: 2,
                dashArray: '5, 5'
            }).addTo(map);
        }

        // Update preview circle radius
        function updatePreviewRadius() {
            const radius = parseInt(document.getElementById('radius').value);
            const lat = parseFloat(document.getElementById('centerLat').value);
            const lng = parseFloat(document.getElementById('centerLng').value);
            
            if (tempCircle && lat && lng) {
                showPreviewCircle(lat, lng, radius);
            }
        }

        // Create geofence
        async function createGeofence() {
            const name = document.getElementById('geofenceName').value;
            const centerLat = parseFloat(document.getElementById('centerLat').value);
            const centerLng = parseFloat(document.getElementById('centerLng').value);
            const radius = parseInt(document.getElementById('radius').value);
            const deviceFilter = document.getElementById('deviceFilter').value;
            
            // Get alert types
            const alertTypes = [];
            if (document.getElementById('alertEnter').checked) alertTypes.push('enter');
            if (document.getElementById('alertExit').checked) alertTypes.push('exit');
            
            if (!name || !centerLat || !centerLng || !radius || alertTypes.length === 0) {
                alert('Please fill in all required fields');
                return;
            }
            
            try {
                const response = await fetch('/api/geofences', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('meta[name=csrf-token]').getAttribute('content')
                    },
                    body: JSON.stringify({
                        name: name,
                        center_lat: centerLat,
                        center_lng: centerLng,
                        radius_meters: radius,
                        device_filter: deviceFilter || null,
                        alert_types: alertTypes
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    // Add to map
                    addGeofenceToMap(result);
                    
                    // Close modal and reset
                    createGeofenceModal.hide();
                    endGeofenceCreation();
                    document.getElementById('createGeofenceForm').reset();
                    
                    // Reload page to refresh lists
                    window.location.reload();
                } else {
                    alert('Error creating geofence: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Failed to create geofence');
            }
        }

        // Delete geofence
        async function deleteGeofence(geofenceId) {
            if (!confirm('Are you sure you want to delete this geofence?')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/geofences/${geofenceId}`, {
                    method: 'DELETE',
                    headers: {
                        'X-CSRFToken': document.querySelector('meta[name=csrf-token]').getAttribute('content')
                    }
                });
                
                if (response.ok) {
                    // Remove from map
                    if (geofenceCircles[geofenceId]) {
                        map.removeLayer(geofenceCircles[geofenceId]);
                        delete geofenceCircles[geofenceId];
                    }
                    
                    // Remove from list
                    const element = document.querySelector(`[data-geofence-id="${geofenceId}"]`);
                    if (element) {
                        element.remove();
                    }
                } else {
                    const result = await response.json();
                    alert('Error deleting geofence: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Failed to delete geofence');
            }
        }

        // Focus on specific geofence
        function focusGeofence(geofenceId) {
            if (geofenceCircles[geofenceId]) {
                const circle = geofenceCircles[geofenceId];
                map.setView(circle.getLatLng(), 15);
                circle.openPopup();
            }
        }

        // Add event listeners
        document.addEventListener('DOMContentLoaded', function() {
            initializeMap();
            
            // Update preview when radius changes
            document.getElementById('radius').addEventListener('input', updatePreviewRadius);
            
            // Reset creation mode when modal is hidden
            document.getElementById('createGeofenceModal').addEventListener('hidden.bs.modal', function() {
                endGeofenceCreation();
            });
        });
    </script>
    <script src="{{ url_for('static', filename='js/notifications.js') }}"></script>
</body>
</html>