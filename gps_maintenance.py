#!/usr/bin/env python3
"""
GPS Performance Maintenance Script
Cleans up address cache and optimizes database for better GPS log performance
"""

import logging
import sys
import os
from datetime import datetime, timedelta
from database import Database

# Configure logging
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)
logger = logging.getLogger(__name__)

class GPSMaintenance:
    def __init__(self):
        self.db = Database()
    
    def cleanup_address_cache(self, keep_count: int = 10000):
        """Clean up old address cache entries"""
        logger.info("Starting address cache cleanup...")
        
        try:
            success = self.db.cleanup_address_cache(keep_count)
            if success:
                logger.info(f"‚úÖ Address cache cleanup completed (kept top {keep_count} entries)")
            else:
                logger.error("‚ùå Address cache cleanup failed")
            return success
        except Exception as e:
            logger.error(f"‚ùå Error during address cache cleanup: {e}")
            return False
    
    def optimize_database_indexes(self):
        """Optimize database indexes for GPS performance"""
        logger.info("Optimizing database indexes...")
        
        try:
            with self.db.get_connection() as conn:\n                cursor = conn.cursor()\n                \n                # Analyze tables to update statistics\n                cursor.execute(\"ANALYZE TABLE locations\")\n                cursor.execute(\"ANALYZE TABLE address_cache\")\n                \n                # Optimize tables\n                cursor.execute(\"OPTIMIZE TABLE locations\")\n                cursor.execute(\"OPTIMIZE TABLE address_cache\")\n                \n                logger.info(\"‚úÖ Database optimization completed\")\n                return True\n                \n        except Exception as e:\n            logger.error(f\"‚ùå Database optimization failed: {e}\")\n            return False\n    \n    def vacuum_logs_table(self, days_to_keep: int = 365):\n        \"\"\"Remove old location records to keep database size manageable\"\"\"\n        logger.info(f\"Cleaning old location records (keeping last {days_to_keep} days)...\")\n        \n        try:\n            cutoff_date = datetime.now() - timedelta(days=days_to_keep)\n            \n            with self.db.get_connection() as conn:\n                cursor = conn.cursor()\n                \n                # Count records to be deleted\n                cursor.execute(\"\"\"\n                    SELECT COUNT(*) as old_count FROM locations \n                    WHERE timestamp < %s\n                \"\"\", (cutoff_date,))\n                \n                result = cursor.fetchone()\n                old_count = result['old_count'] if result else 0\n                \n                if old_count > 0:\n                    logger.info(f\"Found {old_count:,} old records to clean up\")\n                    \n                    # Delete old records in batches to avoid locking\n                    batch_size = 10000\n                    deleted_total = 0\n                    \n                    while True:\n                        cursor.execute(\"\"\"\n                            DELETE FROM locations \n                            WHERE timestamp < %s \n                            LIMIT %s\n                        \"\"\", (cutoff_date, batch_size))\n                        \n                        deleted = cursor.rowcount\n                        if deleted == 0:\n                            break\n                            \n                        deleted_total += deleted\n                        logger.info(f\"Deleted {deleted_total:,} / {old_count:,} old records\")\n                        \n                        # Small delay between batches\n                        import time\n                        time.sleep(0.1)\n                    \n                    logger.info(f\"‚úÖ Cleaned up {deleted_total:,} old location records\")\n                else:\n                    logger.info(\"‚úÖ No old records to clean up\")\n                \n            return True\n            \n        except Exception as e:\n            logger.error(f\"‚ùå Error during logs cleanup: {e}\")\n            return False\n    \n    def generate_performance_report(self):\n        \"\"\"Generate a performance report\"\"\"\n        logger.info(\"Generating performance report...\")\n        \n        try:\n            stats = self.db.get_statistics()\n            \n            with self.db.get_connection() as conn:\n                cursor = conn.cursor()\n                \n                # Get table sizes\n                cursor.execute(\"SHOW TABLE STATUS LIKE 'locations'\")\n                locations_info = cursor.fetchone()\n                \n                cursor.execute(\"SHOW TABLE STATUS LIKE 'address_cache'\")\n                cache_info = cursor.fetchone()\n                \n                # Get index information\n                cursor.execute(\"SHOW INDEX FROM locations\")\n                indexes = cursor.fetchall()\n                \n                report = {\n                    'timestamp': datetime.now().isoformat(),\n                    'database_stats': stats,\n                    'table_sizes': {\n                        'locations': {\n                            'rows': locations_info['Rows'] if locations_info else 0,\n                            'data_size_mb': round((locations_info['Data_length'] or 0) / 1024 / 1024, 2) if locations_info else 0,\n                            'index_size_mb': round((locations_info['Index_length'] or 0) / 1024 / 1024, 2) if locations_info else 0\n                        },\n                        'address_cache': {\n                            'rows': cache_info['Rows'] if cache_info else 0,\n                            'data_size_mb': round((cache_info['Data_length'] or 0) / 1024 / 1024, 2) if cache_info else 0\n                        }\n                    },\n                    'indexes_count': len(indexes) if indexes else 0\n                }\n                \n                # Print report\n                print(\"\\nüìä GPS PERFORMANCE REPORT\")\n                print(\"=\" * 40)\n                print(f\"Generated: {report['timestamp']}\")\n                print(\"\\nüìà Database Statistics:\")\n                print(f\"   Total locations: {stats.get('total_locations', 0):,}\")\n                print(f\"   Unique devices: {stats.get('unique_devices', 0)}\")\n                print(f\"   Today's records: {stats.get('today_count', 0):,}\")\n                print(f\"   Address cache size: {stats.get('address_cache_size', 0):,}\")\n                \n                print(\"\\nüíæ Table Sizes:\")\n                locations_size = report['table_sizes']['locations']\n                print(f\"   Locations: {locations_size['rows']:,} rows, {locations_size['data_size_mb']} MB data, {locations_size['index_size_mb']} MB indexes\")\n                \n                cache_size = report['table_sizes']['address_cache']\n                print(f\"   Address cache: {cache_size['rows']:,} rows, {cache_size['data_size_mb']} MB data\")\n                \n                print(f\"\\nüîç Indexes: {report['indexes_count']} total indexes\")\n                \n                # Save report\n                import json\n                with open('gps_performance_report.json', 'w') as f:\n                    json.dump(report, f, indent=2)\n                \n                logger.info(\"‚úÖ Performance report generated and saved to gps_performance_report.json\")\n                return report\n                \n        except Exception as e:\n            logger.error(f\"‚ùå Error generating performance report: {e}\")\n            return None\n    \n    def run_maintenance(self, cleanup_cache=True, optimize_db=True, cleanup_old_data=False, days_to_keep=365):\n        \"\"\"Run full maintenance routine\"\"\"\n        logger.info(\"üîß Starting GPS performance maintenance\")\n        logger.info(\"=\" * 50)\n        \n        success_count = 0\n        total_tasks = 0\n        \n        # Generate initial report\n        logger.info(\"\\nüìä Initial performance report:\")\n        self.generate_performance_report()\n        \n        # Address cache cleanup\n        if cleanup_cache:\n            total_tasks += 1\n            if self.cleanup_address_cache():\n                success_count += 1\n        \n        # Database optimization\n        if optimize_db:\n            total_tasks += 1\n            if self.optimize_database_indexes():\n                success_count += 1\n        \n        # Old data cleanup (optional)\n        if cleanup_old_data:\n            total_tasks += 1\n            if self.vacuum_logs_table(days_to_keep):\n                success_count += 1\n        \n        # Generate final report\n        logger.info(\"\\nüìä Final performance report:\")\n        self.generate_performance_report()\n        \n        # Summary\n        logger.info(\"\\nüéâ MAINTENANCE COMPLETE\")\n        logger.info(f\"‚úÖ {success_count}/{total_tasks} tasks completed successfully\")\n        \n        if success_count == total_tasks:\n            logger.info(\"üèÜ All maintenance tasks completed successfully!\")\n        else:\n            logger.warning(f\"‚ö†Ô∏è  {total_tasks - success_count} tasks had issues. Check logs above.\")\n        \n        return success_count == total_tasks\n\ndef main():\n    \"\"\"Main function to run maintenance\"\"\"\n    import argparse\n    \n    parser = argparse.ArgumentParser(description='GPS Performance Maintenance')\n    parser.add_argument('--skip-cache-cleanup', action='store_true', help='Skip address cache cleanup')\n    parser.add_argument('--skip-optimize', action='store_true', help='Skip database optimization')\n    parser.add_argument('--cleanup-old-data', action='store_true', help='Enable old data cleanup')\n    parser.add_argument('--days-to-keep', type=int, default=365, help='Days of data to keep (default: 365)')\n    parser.add_argument('--report-only', action='store_true', help='Only generate performance report')\n    \n    args = parser.parse_args()\n    \n    maintenance = GPSMaintenance()\n    \n    if args.report_only:\n        logger.info(\"üìä Generating performance report only...\")\n        maintenance.generate_performance_report()\n    else:\n        success = maintenance.run_maintenance(\n            cleanup_cache=not args.skip_cache_cleanup,\n            optimize_db=not args.skip_optimize,\n            cleanup_old_data=args.cleanup_old_data,\n            days_to_keep=args.days_to_keep\n        )\n        \n        sys.exit(0 if success else 1)\n\nif __name__ == \"__main__\":\n    main()